<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Locator</title>
<link rel="icon" type="image/png" href="/favicon.ico?v=2">
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Share Tech Mono','Courier New',monospace;background:#000;color:#00ff41;max-width:860px;margin:0 auto;padding:16px;
  background-image:repeating-linear-gradient(0deg,rgba(0,255,65,.03) 0px,rgba(0,255,65,.03) 1px,transparent 1px,transparent 3px);
  min-height:100vh}
h1{font-size:1.5em;color:#00ff41;margin-bottom:4px;text-shadow:0 0 10px #00ff41,0 0 20px #00ff4180;letter-spacing:3px}
.subtitle{color:#008f11;font-size:.75em;margin-bottom:12px;letter-spacing:2px}
h2{font-size:1.1em;color:#00ff41;margin-bottom:8px;text-shadow:0 0 8px #00ff4160}
nav{display:flex;gap:6px;margin-bottom:16px;border-bottom:1px solid #003b00;padding-bottom:12px}
nav button{background:transparent;border:1px solid #003b00;color:#008f11;padding:6px 16px;cursor:pointer;font-family:inherit;font-size:.85em;text-transform:uppercase;letter-spacing:1px;transition:all .2s}
nav button:hover{border-color:#00ff41;color:#00ff41;text-shadow:0 0 8px #00ff41;box-shadow:0 0 8px #00ff4130}
nav button.active{border-color:#00ff41;color:#00ff41;background:#00ff4110;text-shadow:0 0 8px #00ff41}
.view{display:none}
.view.active{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
table{width:100%;border-collapse:collapse;margin:8px 0;font-size:.82em}
th,td{padding:7px 10px;text-align:left;border-bottom:1px solid #003b00}
th{background:#001a00;color:#00ff41;text-transform:uppercase;letter-spacing:1px;font-size:.8em;position:sticky;top:0}
tr:hover{background:#00ff4108}
td{color:#00cc33}
button{background:transparent;border:1px solid #003b00;color:#008f11;padding:4px 10px;cursor:pointer;font-family:inherit;font-size:.82em;transition:all .2s}
button:hover{border-color:#00ff41;color:#00ff41;text-shadow:0 0 5px #00ff41}
button.danger{border-color:#3b0000;color:#ff4141}
button.danger:hover{border-color:#ff4141;color:#ff4141;text-shadow:0 0 5px #ff4141}
button.go{border-color:#003b00;color:#00ff41;background:#00ff4115;text-shadow:0 0 5px #00ff4180}
button.go:hover{background:#00ff4125;box-shadow:0 0 12px #00ff4130}
input[type=text],input[type=password]{background:#001a00;border:1px solid #003b00;color:#00ff41;padding:6px 10px;width:100%;max-width:420px;font-family:inherit;font-size:.9em;transition:border-color .2s}
input[type=text]:focus,input[type=password]:focus{outline:none;border-color:#00ff41;box-shadow:0 0 8px #00ff4130}
input[type=text]::placeholder,input[type=password]::placeholder{color:#004d00}
.msg{padding:8px 12px;margin:8px 0;font-size:.85em;border:1px solid}
.msg.ok{border-color:#003b00;color:#00ff41;background:#00ff4110}
.msg.err{border-color:#3b0000;color:#ff4141;background:#ff414110}
.bar{height:5px;background:#001a00;overflow:hidden;margin:4px 0;border:1px solid #003b0050}
.bar .fill{height:100%;transition:width .3s}
#map-frame{width:100%;height:400px;border:1px solid #003b00;background:#000}
.info{color:#006600;font-size:.82em;margin:4px 0}
.cursor{display:inline-block;width:8px;height:1.1em;background:#00ff41;animation:blink 1s step-end infinite;vertical-align:text-bottom;margin-left:2px}
@keyframes blink{50%{opacity:0}}
.glow{text-shadow:0 0 10px #00ff41,0 0 20px #00ff4140}
.panel{border:1px solid #003b00;padding:12px;margin:8px 0;background:#00110a08}
.tag{display:inline-block;padding:1px 6px;border:1px solid #003b00;font-size:.75em;color:#008f11;margin:0 2px}
</style>
</head>
<body>
<h1>ESP32_LOCATOR<span class="cursor"></span></h1>
<div class="subtitle">// WiFi reconnaissance & geolocation system</div>
<nav>
<button onclick="showView('scans')" id="nav-scans">[ Scans ]</button>
<button onclick="showView('settings')" id="nav-settings">[ Config ]</button>
<button onclick="startScanning()" class="go" style="margin-left:auto">[ Start Scanning ]</button>
</nav>

<div id="v-scans" class="view active">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<h2>&gt; stored_scans</h2>
<div><button onclick="exportScans()">Export</button> <button class="danger" onclick="deleteAll()">Purge All</button></div>
</div>
<div id="scan-list" class="panel"></div>
</div>

<div id="v-detail" class="view">
<button onclick="showView('scans')" style="margin-bottom:10px">&lt; back</button>
<h2>&gt; scan_data [<span id="detail-id"></span>]</h2>
<p class="info" id="detail-time"></p>
<div id="detail-aps"></div>
<div id="detail-nav" style="display:flex;justify-content:space-between;margin-top:10px"></div>
</div>

<div id="v-map" class="view">
<button onclick="showView('scans')" style="margin-bottom:10px">&lt; back</button>
<h2>&gt; location [<span id="map-id"></span>]</h2>
<div class="panel" id="map-info" style="margin-bottom:8px"></div>
<iframe id="map-frame" frameborder="0" allowfullscreen></iframe>
<div id="map-nav" style="display:flex;justify-content:space-between;margin-top:10px"></div>
</div>

<div id="v-settings" class="view">
<h2>&gt; configuration</h2>
<div class="panel">
<label class="info">WIFI_CONNECTION</label>
<div id="wifi-status" style="margin:6px 0;font-size:.85em"></div>
<div style="display:flex;gap:8px;margin-top:6px;align-items:center">
<input type="text" id="wifi-ssid" placeholder="SSID" style="max-width:240px" autocomplete="off">
<button onclick="scanWifi()">Scan</button>
</div>
<div id="wifi-scan-results" style="margin:6px 0"></div>
<div style="margin-top:6px">
<input type="password" id="wifi-pass" placeholder="password" style="max-width:240px" autocomplete="off">
</div>
<div style="margin-top:10px;display:flex;gap:8px">
<button class="go" onclick="connectWifi()">[ Connect ]</button>
<button class="danger" onclick="forgetWifi()">[ Forget ]</button>
</div>
<div id="wifi-msg"></div>
</div>
<div class="panel">
<label class="info">GOOGLE_API_KEY</label>
<div style="margin-top:4px">
<input type="password" id="api-key" placeholder="enter_api_key" autocomplete="off">
</div>
<label class="info" style="margin-top:14px;display:block">WEB_PASSWORD</label>
<div style="margin-top:4px">
<input type="password" id="web-pass" placeholder="set_password" autocomplete="off">
</div>
<div style="margin-top:4px">
<input type="password" id="web-pass-confirm" placeholder="confirm_password" autocomplete="off">
</div>
<div style="margin-top:6px"><button class="danger" onclick="clearPassword()">[ Clear Password ]</button> <span id="pass-status"></span></div>
<label class="info" style="margin-top:14px;display:block">SCAN_INTERVAL_SEC</label>
<div style="display:flex;gap:8px;margin-top:4px;align-items:center">
<input type="text" id="scan-interval" placeholder="60" style="max-width:120px">
<span class="info">range: 10-3600</span>
</div>
<div style="margin-top:14px"><button class="go" onclick="saveSettings()">[ Save ]</button></div>
<div id="settings-msg"></div>
</div>
</div>

<script>
const $ = s => document.querySelector(s);
const views = ['scans','detail','map','settings'];
let scanIds = [];

function showView(v) {
  views.forEach(n => {
    const el = document.getElementById('v-'+n);
    if(el) el.classList.toggle('active', n===v);
    const nb = document.getElementById('nav-'+n);
    if(nb) nb.classList.toggle('active', n===v);
  });
  if(v==='scans') loadScans();
  if(v==='settings') loadSettings();
}

function ts(epoch) {
  if(!epoch) return '<span class="tag">NO_TIMESTAMP</span>';
  return new Date(epoch*1000).toLocaleString();
}

function rssiBar(rssi) {
  const pct = Math.max(0, Math.min(100, (rssi+100)*2));
  const color = pct>60?'#00ff41':pct>30?'#ffaa00':'#ff4141';
  return `<div class="bar" style="width:60px;display:inline-block"><div class="fill" style="width:${pct}%;background:${color}"></div></div> ${rssi}dBm`;
}

function haversine(lat1, lon1, lat2, lon2) {
  const r = 6371.0;
  const dLat = (lat2 - lat1) * Math.PI / 180.0;
  const dLon = (lon2 - lon1) * Math.PI / 180.0;
  const la1 = lat1 * Math.PI / 180.0;
  const la2 = lat2 * Math.PI / 180.0;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return r * c;
}

function fmtDist(km) {
  if (km < 1) return Math.round(km * 1000) + 'm';
  return km.toFixed(2) + 'km';
}

let scanData = [];

async function loadScans() {
  const r = await fetch('/api/scans');
  const data = await r.json();
  scanData = data;
  scanIds = data.map(s => s.id);
  if(!data.length) {
    $('#scan-list').innerHTML = '<div class="panel"><span class="info">No scan records found.</span></div>';
    return;
  }
  // Compute distances between consecutively located scans
  let prevLoc = null;
  const distances = {};
  data.forEach(s => {
    if (s.lat !== undefined) {
      if (prevLoc) {
        distances[s.id] = haversine(prevLoc.lat, prevLoc.lng, s.lat, s.lng);
      }
      prevLoc = { lat: s.lat, lng: s.lng };
    }
  });

  let h = '<table><tr><th>idx</th><th>timestamp</th><th>aps</th><th>diffs</th><th>dist</th><th>actions</th></tr>';
  data.forEach(s => {
    const d = s.diffs !== undefined ? s.diffs : '-';
    const dclass = (s.diffs !== undefined && s.diffs > s.aps / 2) ? ' style="color:#ff4141;text-shadow:0 0 5px #ff4141"' : '';
    const located = s.lat !== undefined;
    const locBtn = located ? '<button onclick="locateScan('+s.id+')" style="font-weight:bold;border-color:#00ff41;color:#00ff41">Locate</button>' : '<button onclick="locateScan('+s.id+')">Locate</button>';
    const dist = distances[s.id] !== undefined ? fmtDist(distances[s.id]) : '-';
    h += `<tr><td>${String(s.id).padStart(5,'0')}</td><td>${ts(s.timestamp)}</td><td>${s.aps}</td><td${dclass}>${d}</td><td>${dist}</td><td>
      <button onclick="viewScan(${s.id})">View</button>
      ${locBtn}
      <button class="danger" onclick="deleteScan(${s.id})">Del</button></td></tr>`;
  });
  h += '</table>';
  $('#scan-list').innerHTML = h;
}

function navButtons(id, fn, midBtn) {
  const idx = scanIds.indexOf(id);
  const prev = idx > 0 ? scanIds[idx-1] : null;
  const next = idx < scanIds.length-1 ? scanIds[idx+1] : null;
  let h = prev !== null ? `<button onclick="${fn}(${prev})">&lt; Prev</button>` : '<span></span>';
  h += midBtn || '';
  h += next !== null ? `<button onclick="${fn}(${next})">Next &gt;</button>` : '<span></span>';
  return h;
}

async function viewScan(id) {
  const r = await fetch('/api/scan?id='+id);
  const data = await r.json();
  $('#detail-id').textContent = String(id).padStart(5,'0');
  $('#detail-time').innerHTML = 'timestamp: ' + ts(data.timestamp);
  let h = '<table><tr><th>SSID</th><th>BSSID</th><th>Signal</th><th>Ch</th><th>Auth</th></tr>';
  data.aps.forEach(a => {
    h += `<tr><td>${a.ssid||'<span class="info">&lt;hidden&gt;</span>'}</td><td>${a.bssid}</td>
      <td>${rssiBar(a.rssi)}</td><td>${a.channel}</td><td><span class="tag">${a.auth}</span></td></tr>`;
  });
  h += '</table>';
  $('#detail-aps').innerHTML = h;
  $('#detail-nav').innerHTML = navButtons(id, 'viewScan', `<button onclick="locateScan(${id})">Locate</button>`);
  showView('detail');
}

async function locateScan(id) {
  showView('map');
  $('#map-id').textContent = String(id).padStart(5,'0');
  $('#map-info').innerHTML = '<span class="glow">Requesting geolocation...</span><span class="cursor"></span>';
  $('#map-frame').src = '';
  try {
    const r = await fetch('/api/locate?id='+id, {method:'POST'});
    if(!r.ok) { $('#map-info').innerHTML = `<span class="msg err">ERR: ${await r.text()}</span>`; return; }
    const loc = await r.json();
    const cachedTag = loc.cached ? ' <span class="tag">CACHED</span>' : ' <span class="tag" style="border-color:#00ff41;color:#00ff41">NEW</span>';
    $('#map-info').innerHTML = `LAT: ${loc.lat.toFixed(6)} &nbsp; LNG: ${loc.lng.toFixed(6)} &nbsp; ACC: ${loc.accuracy.toFixed(0)}m${cachedTag}`;
    if(loc.map_url) {
      $('#map-frame').src = loc.map_url;
    } else {
      $('#map-info').innerHTML += '<br><span class="info">Set API key in Config to render map.</span>';
    }
    // Refresh scan list in background so overview picks up new location data
    if (!loc.cached) {
      fetch('/api/scans').then(r=>r.json()).then(d=>{ scanData=d; scanIds=d.map(s=>s.id); });
    }
  } catch(e) {
    $('#map-info').innerHTML = `<span class="msg err">CONNECTION_FAILED: ${e.message}</span>`;
  }
  $('#map-nav').innerHTML = navButtons(id, 'locateScan', `<button onclick="viewScan(${id})">View</button>`);
}

async function deleteScan(id) {
  if(!confirm('ERASE scan #'+id+'?')) return;
  await fetch('/api/scan?id='+id, {method:'DELETE'});
  loadScans();
}

async function deleteAll() {
  if(!confirm('PURGE all scan records from NVS?')) return;
  await fetch('/api/scans', {method:'DELETE'});
  loadScans();
}

async function exportScans() {
  const r = await fetch('/api/scans');
  const list = await r.json();
  if(!list.length) { alert('No scans to export.'); return; }
  const scans = [];
  for(const s of list) {
    const dr = await fetch('/api/scan?id='+s.id);
    scans.push(await dr.json());
  }
  // Filename: LocatorScan_ + date/time of first scan
  const firstTs = list[0].timestamp;
  let dtStr;
  if (firstTs) {
    const d = new Date(firstTs * 1000);
    dtStr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0')
      + '_' + String(d.getHours()).padStart(2,'0') + String(d.getMinutes()).padStart(2,'0') + String(d.getSeconds()).padStart(2,'0');
  } else {
    dtStr = new Date().toISOString().slice(0,10);
  }
  const blob = new Blob([JSON.stringify(scans, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'LocatorScan_' + dtStr + '.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

async function loadSettings() {
  const r = await fetch('/api/settings');
  const data = await r.json();
  $('#api-key').value = '';
  $('#api-key').placeholder = data.api_key_set ? '(key configured)' : 'enter_api_key';
  $('#web-pass').value = '';
  $('#web-pass-confirm').value = '';
  $('#web-pass').placeholder = data.web_pass_set ? '(password set)' : 'set_password';
  $('#web-pass-confirm').placeholder = data.web_pass_set ? '(confirm)' : 'confirm_password';
  $('#pass-status').innerHTML = data.web_pass_set ? '<span class="tag" style="border-color:#ffaa00;color:#ffaa00">LOCKED</span>' : '';
  $('#scan-interval').value = data.scan_interval || 60;
  loadWifiStatus();
}

async function loadWifiStatus() {
  try {
    const r = await fetch('/api/wifi/status');
    const d = await r.json();
    const modeTag = d.mode === 'STA'
      ? '<span class="tag" style="border-color:#00ff41;color:#00ff41">STA</span>'
      : '<span class="tag" style="border-color:#ffaa00;color:#ffaa00">AP</span>';
    const ssidInfo = d.ssid ? ` &nbsp; SSID: ${d.ssid}` : '';
    $('#wifi-status').innerHTML = `${modeTag} &nbsp; IP: ${d.ip}${ssidInfo}`;
  } catch(e) {
    $('#wifi-status').innerHTML = '<span class="info">STATUS_UNAVAILABLE</span>';
  }
}

async function scanWifi() {
  $('#wifi-scan-results').innerHTML = '<span class="info">Scanning...</span><span class="cursor"></span>';
  try {
    const r = await fetch('/api/wifi/scan');
    const nets = await r.json();
    if(!nets.length) {
      $('#wifi-scan-results').innerHTML = '<span class="info">No networks found.</span>';
      return;
    }
    let h = '<table><tr><th>SSID</th><th>Signal</th><th>Auth</th><th>Ch</th><th></th></tr>';
    nets.forEach(n => {
      h += `<tr><td>${n.ssid}</td><td>${rssiBar(n.rssi)}</td><td><span class="tag">${n.auth}</span></td><td>${n.channel}</td>
        <td><button onclick="selectNet('${n.ssid.replace(/'/g,"\\'")}')">Select</button></td></tr>`;
    });
    h += '</table>';
    $('#wifi-scan-results').innerHTML = h;
  } catch(e) {
    $('#wifi-scan-results').innerHTML = '<span class="msg err">SCAN_FAILED</span>';
  }
}

function selectNet(ssid) {
  $('#wifi-ssid').value = ssid;
  $('#wifi-pass').focus();
}

async function connectWifi() {
  const ssid = $('#wifi-ssid').value.trim();
  if(!ssid) { $('#wifi-msg').innerHTML = '<p class="msg err">SSID required</p>'; return; }
  const pass = $('#wifi-pass').value;
  if(!confirm(`Connect to "${ssid}"?\nDevice will reboot.`)) return;
  $('#wifi-msg').innerHTML = '<p class="msg ok">Saving credentials and rebooting...<span class="cursor"></span></p>';
  try {
    await fetch('/api/wifi/connect', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ssid, password:pass})
    });
  } catch(e) { /* device reboots, connection drops â€” expected */ }
}

async function forgetWifi() {
  if(!confirm('Forget WiFi credentials?\nDevice will reboot to AP mode.')) return;
  $('#wifi-msg').innerHTML = '<p class="msg ok">Clearing credentials...<span class="cursor"></span></p>';
  try {
    await fetch('/api/wifi/forget', {method:'POST'});
  } catch(e) { /* reboot expected */ }
}

async function saveSettings() {
  const key = $('#api-key').value.trim();
  const pass = $('#web-pass').value;
  const passConfirm = $('#web-pass-confirm').value;
  const ivl = parseInt($('#scan-interval').value) || 60;
  if (pass !== '' && pass !== passConfirm) {
    $('#settings-msg').innerHTML = '<p class="msg err">PASSWORDS_DO_NOT_MATCH</p>';
    setTimeout(() => $('#settings-msg').innerHTML = '', 4000);
    return;
  }
  if (ivl < 10 || ivl > 3600) {
    $('#settings-msg').innerHTML = '<p class="msg err">WARN: scan interval must be 10-3600 seconds</p>';
    setTimeout(() => $('#settings-msg').innerHTML = '', 4000);
    return;
  }
  const payload = {api_key:key, scan_interval:ivl};
  if (pass !== '') payload.web_password = pass;
  const r = await fetch('/api/settings', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  $('#settings-msg').innerHTML = r.ok
    ? '<p class="msg ok">CONFIG_SAVED</p>'
    : '<p class="msg err">WRITE_FAILED</p>';
  setTimeout(() => $('#settings-msg').innerHTML = '', 3000);
  if (r.ok) loadSettings();
}

async function clearPassword() {
  if(!confirm('Remove web server password?\nAccess will be open to anyone on the network.')) return;
  const r = await fetch('/api/settings', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({web_password:''})
  });
  $('#settings-msg').innerHTML = r.ok
    ? '<p class="msg ok">PASSWORD_CLEARED</p>'
    : '<p class="msg err">CLEAR_FAILED</p>';
  setTimeout(() => $('#settings-msg').innerHTML = '', 3000);
  if (r.ok) loadSettings();
}

async function startScanning() {
  const ivl = $('#scan-interval')?.value || '60';
  if(!confirm(`ENTER SCAN MODE?\n\nInterval: ${ivl}s\nWiFi will disconnect.\nPress BOOT to return.`)) return;
  await fetch('/api/sleep', {method:'POST'});
  document.body.innerHTML = '<div style="text-align:center;margin-top:80px"><h1 class="glow" style="font-size:1.8em">ENTERING DEEP SLEEP<span class="cursor"></span></h1><p style="color:#008f11;margin-top:16px;letter-spacing:2px">// scanning active &mdash; press BOOT to wake</p></div>';
}

loadScans();
</script>
</body>
</html>
